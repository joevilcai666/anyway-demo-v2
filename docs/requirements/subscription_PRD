#### 二、产品内 - 套餐管理（Account > Subscription）

**入口位置**

```
Account Settings
├── **Subscription**（订阅管理）← 新增
└── Developers
```

**Subscription 页面结构**

```
┌─────────────────────────────────────────────────────────┐
│  Current Plan Section                                   │
│  ┌─────────────────────────────────────────────────┐   │
│  │  [Pro Plan]                     $49/month        │   │
│  │  Renews on Feb 20, 2026                          │   │
│  │                                                   │   │
│  │  [Manage Payment] [Cancel Subscription]          │   │
│  └─────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│  Usage This Billing Cycle                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │  计算单元: 8,234 / 50,000 used                    │   │
│  │  ████████████░░░░░░░░░░░░░░░░░░  16.5%           │   │
│  │                                                   │   │
│  │  预计本月用量: 12,000 Units                        │   │
│  │  [View Usage Details]                             │   │
│  └─────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│  Plan Comparison (Upgrade Options)                     │
│  ┌────────┐ ┌────────┐ ┌────────┐                     │
│  │ Starter│ │  Pro   │ │ Enterp │                     │
│  │ Current│ │Upgrade │ │Contact │                     │
│  └────────┘ └────────┘ └────────┘                     │
├─────────────────────────────────────────────────────────┤
│  Billing History                                        │
│  - Jan 20, 2026 - $49.00 - Paid ✓                      │
│  - Dec 20, 2025 - $29.00 - Paid ✓                      │
│  [View All Invoices]                                    │
└─────────────────────────────────────────────────────────┘
```

**订阅状态定义**

| 状态 | 说明 | 前端展示 |
| --- | --- | --- |
| `active` | 正常订阅中 | 显示续订日期 |
| `trialing` | 试用期（如有） | 显示试用结束日期 |
| `past_due` | 付款失败，宽限期 | 警告 banner + 更新支付方式入口 |
| `canceled` | 已取消，等待到期 | 显示服务结束日期 |
| `expired` | 已过期，降级为 Free | 升级引导 |

**状态流转**

```
┌─────────┐   付款成功   ┌─────────┐
│ trialing│ ──────────► │ active  │
└─────────┘             └────┬────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
        ┌─────────┐   ┌─────────┐    ┌─────────┐
        │ past_due│   │ canceled│    │ upgraded│
        │（宽限期）│   │（待到期）│    │（新套餐）│
        └────┬────┘   └────┬────┘    └─────────┘
             │              │
             ▼              ▼
        ┌─────────┐   ┌─────────┐
        │ expired │◄──│ expired │
        │（降Free）│   └─────────┘
        └─────────┘
```

---

#### 三、关键场景处理

**场景 1：升级套餐**

| 步骤 | 说明 |
| --- | --- |
| 1 | 点击 Upgrade → 打开套餐对比 modal 或跳转 Pricing 页 |
| 2 | 选择目标套餐（高亮当前套餐，其他可选） |
| 3 | 确认变更，显示 prorate 金额（立即扣款差额） |
| 4 | 支付：Stripe Checkout / 使用已绑定卡 |
| 5 | 成功：立即生效，刷新权益 |

Prorate 计算：`应付金额 = (新套餐价格 - 旧套餐价格) × (剩余天数 / 30)`

**场景 2：取消订阅**

| 步骤 | 说明 |
| --- | --- |
| 1 | 点击 Cancel → 弹出确认 modal |
| 2 | 挽留页面：显示将失去的权益 + 优惠挽留（可选） |
| 3 | 确认取消，填写取消原因（可选） |
| 4 | 完成：状态变为 `canceled`，显示服务结束日期 |
| 5 | 到期：自动降级为 Free |

**场景 3：付款失败（past_due）**

| 触发 | 处理 |
| --- | --- |
| Stripe webhook: `invoice.payment_failed` | 标记为 `past_due` |
| 前端展示 | 顶部红色 banner："付款失败，请更新支付方式" |
| 重试机制 | Stripe 自动重试 3 次（1/3/5 天） |
| 宽限期结束 | 降级为 Free |

**场景 4：用量预警**

| 阈值 | 行为 |
| --- | --- |
| 80% 用量 | 产品内 notification + 邮件提醒 |
| 100% 用量 | 提示升级或超额计费即将生效 |
| 100%+ 用量（Free 用户） | **限制新 Trace 上报**，引导升级 |
| 100%+ 用量（付费用户） | 允许继续使用，按超额单价计费 |

---

| 场景 | 当前套餐卡片 | 用量区域 | CTA |
| --- | --- | --- | --- |
| Free 用户 | Free (Current) | X / 500 Units | Upgrade to unlock more |
| 付费用户正常 | Pro (Current) | 8,234 / 50,000 | Manage / Cancel |
| 用量 >80% | Pro (Current) | 42,000 / 50,000 ⚠️ | Consider upgrading |
| 用量超额 | Pro (Current) | 52,000 / 50,000 + $6 overage | View overage details |
| 付款失败 | Pro (Past Due) ⚠️ | — | Update payment method |
| 已取消待到期 | Pro (Canceling) | Ends Feb 20 | Reactivate |